/// rdmap.dev:8801/chat Web Server 
// Contact: business@rdmap.dev
// Last Updated: 12/5/2022
const express = require("express");
const cors = require("cors");
const fs = require("fs");

const app = express();
const port = 8801; // set to 8801 to obscure app development

const messageLogFile = require("./logs/chat-log.json");


// API Middleware (A.K.A. Death to CORS) 
// Updated 2022-12-22
app.use(function (req, res, next) {
	
	express.json();

	res.header("Access-Control-Allow-Origin", "*");
	res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
	next(); // Why is this necessary???
})
app.use(express.json());
app.use(cors());
app.options('*', cors());
// --end of middleware

// HTTP Routes
app.get("/chat", (req, res) => {
	console.log("--USER GET /chat");
	res.send("Chat is working.");
	res.send("The client files would now be sent over.");
});

app.get("/chat/log", (req, res) => {
	console.log("--USER GET /chat/log");
	res.status(200).json(messageLogFile);
});

app.post("/chat/submit", (req, res) => {
	console.log("--USER POST /chat/submit");
	console.log("--DEVELOPMENT REQ: " + req); // for development
	
	const { username } = req.body;
	const { content } = req.body;
	const body = req.body;
	console.log(body);

	// Check for no content
	if (!content) {
		res.status(400).send({ message: "--ROADMAP CHAT SERVER: 400 NO CONTENT" });
		console.log("--USER POST (previous): NO CONTENT");
	}

	res.send({
		message: "--ROADMAP CHAT SERVER: 200 MESSAGE RECEIVED",
	});
	console.log(username, "says:", content);
	
	// WRITE TO MESSAGELOGFILE JSON FILE
	file = fs.readFile("./logs/chat-log.json");
    	messages = JSON.parse(file);
	messages.push(body);
	fs.writeFile(filename, JSON.stringify(messages, null, 4));
});

// Main
app.listen(port, function(err){ 
	if (err) console.log("The server has encountered a runtime error. Please restart.")
	console.log("rdmap.dev/chat server version 0.1.0b - 139.177.195.118:8801/chat");
	console.log("THIS IS DEVELOPMENT SOFTWARE AND COMES WITH ABSOLUTELY NO WARRANTY.");
	console.log("Available resources: /chat, /chat/log, /chat/submit");
})



